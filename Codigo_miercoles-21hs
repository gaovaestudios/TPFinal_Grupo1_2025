#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Keypad.h>

LiquidCrystal_I2C lcd(0x27, 16, 2); // Cambiar a 0x3F si el display no responde

// ---- Configuración Keypad ----
const byte ROWS = 4;
const byte COLS = 4;
char keys[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'*','0','#','D'}
};
byte rowPins[ROWS] = {10, 9, 8, 7};
byte colPins[COLS] = {6, 5, 4, 3};
Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// ---- Pines sensores ----
int buzzer = 12;
int tempAnalog = A1;  // KY-028 A0 conectado aquí
int tempDigital = 11; // KY-028 D0 conectado aquí

bool runningBPM = false;
bool lcdOK = false;

void setup() {
  Serial.begin(9600);
  pinMode(buzzer, OUTPUT);
  pinMode(tempDigital, INPUT);

  // Inicializar LCD
  Wire.begin();
  lcdOK = true;
  lcd.init();
  lcd.backlight();

  if (lcdOK) {
    lcd.setCursor(0, 0);
    lcd.print("Iniciando...");
  }
  Serial.println("=== Sistema de Sensores (KY-028) ===");
  Serial.println("1) BPM  2) Beep 3s  3) Temperatura  0) Apagar");

  delay(1000);
  showMenu();
}

void loop() {
  char key = keypad.getKey();

  if (key) {
    if (!runningBPM) {
      switch (key) {
        case '1':
          Serial.println("[1] Sensor BPM encendido");
          if (lcdOK) {
            lcd.clear();
            lcd.print("Sensor BPM ON");
          }
          runningBPM = true;
          // Aquí va el código de BPM
          break;

        case '2':
          Serial.println("[2] Beep 3 segundos...");
          if (lcdOK) {
            lcd.clear();
            lcd.print("Beep 3 segundos");
          }
          tone(buzzer, 1000, 3000);
          delay(3000);
          noTone(buzzer);
          showMenu();
          break;

        case '3':
          mostrarTemperatura();
          break;

        case '0':
          Serial.println("[0] Apagado");
          if (lcdOK) {
            lcd.clear();
            lcd.print("Apagado...");
          }
          noTone(buzzer);
          runningBPM = false;
          delay(1000);
          showMenu();
          break;
      }
    } else {
      // Si el BPM está activo, permitir 0 o 2 para apagar
      if (key == '0' || key == '2') {
        Serial.println("[BPM] Apagado");
        noTone(buzzer);
        runningBPM = false;
        if (lcdOK) {
          lcd.clear();
          lcd.print("BPM apagado");
          delay(1000);
        }
        showMenu();
      }
    }
  }
}

// ---- Funciones ----

void showMenu() {
  if (lcdOK) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("1:BPM 2:Beep3s");
    lcd.setCursor(0, 1);
    lcd.print("3:Temp 0:Off");
  }

  Serial.println("----------------------------");
  Serial.println("Menu principal:");
  Serial.println("1) Sensor BPM");
  Serial.println("2) Beep 3s");
  Serial.println("3) Temp ambiente");
  Serial.println("0) Apagar");
}

void mostrarTemperatura() {
  if (lcdOK) {
    lcd.clear();
    lcd.print("Midiendo temp...");
  }
  Serial.println("[3] Modo temperatura KY-028");

  unsigned long t0 = millis();
  float suma = 0;
  int lecturas = 0;

  while (millis() - t0 < 5000) {  // medir durante 5 s
    int analogVal = analogRead(tempAnalog);
    int digitalVal = digitalRead(tempDigital);

    // Calibración práctica del KY-028
    float tempC = map(analogVal, 100, 800, 0, 50); // ajustar según tus valores

    suma += tempC;
    lecturas++;

    Serial.print("Temp: ");
    Serial.print(tempC, 1);
    Serial.print(" °C | D0=");
    Serial.println(digitalVal);

    if (lcdOK) {
      lcd.setCursor(0, 0);
      lcd.print("Temp: ");
      lcd.print(tempC, 1);
      lcd.print(" C   ");
      lcd.setCursor(0, 1);
      lcd.print("D0: ");
      lcd.print(digitalVal);
    }

    // Si el pin digital se activa → beep
    if (digitalVal == HIGH) {
      tone(buzzer, 2000, 500);
      Serial.println("⚠️ Temperatura alta!");
    }

    delay(300);
  }

  float promedio = suma / lecturas;

  Serial.print("Promedio final: ");
  Serial.print(promedio, 1);
  Serial.println(" °C");

  if (lcdOK) {
    lcd.clear();
    lcd.print("Promedio:");
    lcd.setCursor(0, 1);
    lcd.print(promedio, 1);
    lcd.print(" C");
  }

  delay(2000);
  showMenu();
}
